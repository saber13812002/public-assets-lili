class MediaLibrary{constructor(e={}){this.options=Object.assign({type:"photo",accept:["*"],saveUrl:null,fetchUrl:null,uploadUrl:null,deleteUrl:null,updateUrl:null,openOnLibrary:!0,uploadWithUrl:!1,useTitle:!0,titleRequired:!1,useTag:!0,useDescription:!0,multiple:!1,limit:10,limitSize:10,cropRatio:3/4,translate:{},data:{},onSave:function(e){},onSaveError:function(e){}},e),this.translate=Object.assign({title:"Media Library",library:"Library",upload:"Upload",uploading:"Uploading...",saveWait:"please wait...",selected:"selected",save:"Apply",cancel:"Cancel",notFound:"Not found item.",errorConnect:"Can not connect to server.",uploadZoneTitle:'<b>Click to upload</b> <span class="visible-desktop">or drag and drop</span> your file',uploadZoneDescription:"Allowed format: PNG, JPG (Up to: 1 photo/10 Mb)",uploadZoneNoSelected:"Please select an item",uploadZoneFieldTitle:"Title",uploadZoneFieldTitlePlaceholder:"Enter Title",uploadZoneFieldDesc:"Description",uploadZoneFieldDescPlaceholder:"Enter Description",uploadZoneFieldTags:"Tags",uploadZoneFieldTagsPlaceholder:"Enter Tags",uploadZoneFieldTagsAdd:"Add Tag",uploadZoneFieldTagsSave:"Save Tag",uploadZoneUploadButton:"Upload",uploadZoneCancelButton:"Cancel Upload",editFormTitle:"Edit",editFormSaveButton:"Save",editFormCancelButton:"Cancel",editFormCropButton:"Crop"},this.options.translate),this.frame=this.frameElement(),this.gridLibrary=this.gridLibraryElement(),this.uploadZone=this.uploadZoneElement(),this.loading=$('<div class="center-content"><div class="loader"></div></div>'),this.tabLibrary=$(`<button type="button" class="tab ${this.options.openOnLibrary?"active":""}">${this.translate.library}</button>`),this.tabUpload=$(`<button type="button" class="tab ${this.options.openOnLibrary?"":"active"}">${this.translate.upload}</button>`),this.saveButton=$(`<button type="button" class="btn btn-primary">${this.translate.save}</button>`),this.cancelButton=$(`<button type="button" class="btn">${this.translate.cancel}</button>`),this.itemSelected=[],this.items=[],this.uploading=!1,this.fileUrl=null,$("body").append(this.frame),bodyOverflowController(!0),this.init()}init(){const e=this;this.frame.find(".content").append(this.loading),$.ajax({url:this.options.fetchUrl,type:"GET",data:this.options.data,success:function(t){e.items=t,e.loading.remove(),e.frame.find(".header .actions").append([e.tabLibrary,e.tabUpload]),e.frame.find(".content").append([e.gridLibrary,e.uploadZone]),e.frame.find(".footer").append([e.cancelButton,e.saveButton]),e.generateItem()},error:function(t){e.loading.remove(),e.frame.find(".content").append(`<div class="center-content">${e.translate.errorConnect}</div>`),e.frame.find(".footer").append([e.cancelButton])}}),this.tabUpload.on("click",(function(){e.uploadZone.show(),e.gridLibrary.hide(),e.tabUpload.addClass("active"),e.tabLibrary.removeClass("active"),e.uploading&&(e.frame.find(".footer button").show(),e.saveButton.hide(),e.cancelButton.hide())})),this.tabLibrary.on("click",(function(){e.uploadZone.hide(),e.gridLibrary.show(),e.tabLibrary.addClass("active"),e.tabUpload.removeClass("active"),e.uploading&&(e.frame.find(".footer button").hide(),e.saveButton.show(),e.cancelButton.show())})),this.saveButton.on("click",(function(){0!==e.itemSelected.length?(e.saveButton.addClass("disable"),$(this).html(e.translate.saveWait),$.ajax({url:e.options.saveUrl,type:"POST",data:{selected:e.itemSelected,data:e.options.data},success:function(t){e.saveButton.removeClass("disable").html(e.translate.save),e.options.onSave(t),e.dispose()},error:function(t){e.alertPopUp("danger","A problem occurred, please try again"),e.saveButton.removeClass("disable").html(e.translate.save),e.options.onSaveError(t)}})):e.alertPopUp("danger",e.translate.uploadZoneNoSelected)})),this.cancelButton.on("click",(function(){e.dispose()}))}dispose(){$(".audio-card.play .pause-btn").trigger("click"),this.frame.remove(),bodyOverflowController()}generateItem(){const e=this;0!==this.items.length&&(this.gridLibrary.html(""),this.items.forEach((function(t){let n=!1;e.itemSelected.length<e.options.limit&&(e.options.multiple&&t.selected||0===e.itemSelected.length&&t.selected)&&(e.itemSelected.push(t.id),n=!0);const i=$(`<div class="item ${n?"selected":""}" data-id="${t.id}">\n                <div class="item-content">\n                    <div class="item-info">\n                        <div class="title"></div><div class="tags"></div>\n                        <div class="selected">${e.translate.selected}</div>\n                    </div>\n                    <div class="item-actions">\n                        <button type="button" class="remove ignore"><i class="icon-trash-2"></i></button>\n                        <button type="button" class="edit ignore"><i class="icon-edit"></i></button>\n                    </div>\n                </div>\n            </div>`);"photo"===e.options.type?i.prepend(e.photoItem(t)):"video"===e.options.type?i.prepend(e.videoItem(t)):"audio"===e.options.type?i.prepend(e.audioItem(t)):i.prepend(e.otherItems(t)),i.find(".item-info .title").html(t.title),i.find(".item-info .tags").html(t.tags.join(", ")),i.on("click","*.ignore",(function(){return!1})),i.on("click","button.remove",(function(){let n=$('<button type="button" class="btn btn-full btn-primary">Ok</button>'),o=$('<button type="button" class="btn btn-full">Cancel</button>'),a=addAlertPopup({class:"",type:"icon",status:"warning",title:"Should the file be deleted?",actionElements:[o,n],actionLayout:"horizontal"});n.on("click",(function(){n.addClass("disable").html("Waiting..."),o.hide(),$.ajax({url:e.options.deleteUrl,type:"POST",data:t,success:function(n){let o=e.itemSelected.indexOf(t.id);e.itemSelected.splice(o,1),$(".audio-card.play .pause-btn").trigger("click"),i.remove(),a.distory()},error:function(t){a.distory(),e.alertPopUp("danger","The file could not be deleted. Check your internet connection and try again.")}})})),o.on("click",(function(){a.distory()}))})),i.on("click","button.edit",(function(){e.editElement(t)})),i.on("click",(function(){if($(this).hasClass("selected")){$(this).removeClass("selected");let t=e.itemSelected.indexOf($(this).data("id"));e.itemSelected.splice(t,1)}else{if(e.itemSelected.length>=e.options.limit)return void e.alertPopUp("danger",`You are allowed to choose ${e.options.limit} items.`);e.options.multiple?($(this).addClass("selected"),e.itemSelected.push($(this).data("id"))):(e.gridLibrary.find(".item").removeClass("selected"),$(this).addClass("selected"),e.itemSelected=[$(this).data("id")])}})),e.gridLibrary.append(i)})),initAudioCard())}frameElement(){const e=this,t=$(`<div class="media-library">\n            <div class="inner-wrapper">\n                <div class="header">\n                    <div class="title">${this.translate.title}</div>\n                    <div class="actions"></div>\n                </div>\n                <div class="content type-${this.options.type}"></div>\n                <div class="footer"></div>\n            </div>\n            <div class="overlay"></div>\n        </div>`);return t.on("click",".overlay",(function(){e.dispose()})),t}gridLibraryElement(){return $(`<div class="grid-library" style="display: ${this.options.openOnLibrary?"grid":"none"}"></div>`)}uploadZoneElement(){const e=this,t=1024*parseInt(this.options.limitSize)*1024,n=$(`<div class="upload-zone" style="display: ${this.options.openOnLibrary?"none":"flex"}">\n            <div class="zone-content"></div>\n            <div class="zone-info">\n                <i class="icon-upload"></i>\n                <div class="title">${this.translate.uploadZoneTitle}</div>\n                <div class="description">${this.translate.uploadZoneDescription}</div>\n            </div>\n            \n        </div>`);e.options.uploadWithUrl&&n.append('<div class="url-file"><input type="text" placeholder="Enter the url of the file"><button type="button" class="btn btn-primary">Go</button></div>'),n.on("dragover",(function(e){e.preventDefault(),n.addClass("draged")})),n.on("dragleave dragend",(function(e){n.removeClass("draged")})),n.on("drop",(function(e){e.preventDefault(),n.removeClass("draged"),"div"===e.target.tagName.toLowerCase()&&o(e.originalEvent.dataTransfer.files)}));const i=$('<input type="file"/>');function o(n){if(0!==n.length)if(e.uploading)e.alertPopUp("danger","A file is being uploaded, please continue the process after uploading the file.");else if(n.length>1)e.alertPopUp("danger","Only one file can be uploaded. After uploading one file, you can upload other files.");else{for(let i=0;i<n.length;i++){if("photo"===e.options.type){if("image/jpeg"!==n[i].type&&"image/png"!==n[i].type)return void e.alertPopUp("danger","You are allowed to use jpg and png format")}else if("video"===e.options.type){if("video/mp4"!==n[i].type)return void e.alertPopUp("danger","You are allowed to use mp4 format")}else if("audio"===e.options.type){if("audio/mpeg"!==n[i].type)return void e.alertPopUp("danger","You are allowed to use mp3 format")}else{const t=n[i].name.match(/\.([a-zA-Z0-9]+)$/);if("*"!==e.options.accept[0]&&!e.options.accept.includes(t[0]))return void e.alertPopUp("danger","You are not authorized to use this format")}if(n[i].size>t)return void e.alertPopUp("danger",`The maximum allowed size is ${e.options.limitSize}MB`)}if("photo"===e.options.type){let t=new FileReader,i=new PhotoSelector({aspectRatio:e.options.cropRatio,onDoneCrop:function(t){e.zonePreview(t.blob,n[0].name)}});return t.readAsDataURL(n[0]),void(t.onload=function(e){i.base64=e.target.result,i.crop()})}e.zonePreview(n)}}return"photo"===e.options.type?i.attr("accept",[".png",".jpg"].join(",")):"video"===e.options.type?i.attr("accept",[".mp4"].join(",")):"audio"===e.options.type?i.attr("accept",[".mp3"].join(",")):i.attr("accept",e.options.accept.join(",")),n.on("click",(function(t){e.uploading||"div"===t.target.tagName.toLowerCase()&&(i.val(""),i.trigger("click"))})),n.on("click",".url-file button",(function(){const t=n.find(".url-file input").val();""!==t.trim()?e.isValidURL(t)?(e.fileUrl=t,n.find(".url-file input").val(""),e.zonePreview(null)):e.alertPopUp("danger","The url format is incorrect"):e.alertPopUp("danger","Please enter the url")})),i.on("change",(function(){o(this.files)})),n}zoneAjax(e,t){const n=this;n.uploadZone.find(".zone-content").css("overflow","hidden"),n.uploadZone.find(".zone-content").append('<div class="zone-loading"><div class="loader"></div><div class="progress-bar"><div class="progress-percent"><span>0</span>%</div><div class="progress-track"><div class="progress-track-processed"></div></div></div></div>'),n.frame.find(".footer button.btn-upload, .edit-form .footer button").addClass("disable"),n.frame.find(".edit-form .edit-content").append('<div class="edit-loading"><div class="loader"></div></div>'),n.uploadZone.find(".zone-content")[0].scrollTop=0,"false"===e.get("file")?n.frame.find(".edit-loading").append(`<span>${this.translate.saveWait}</span>`):n.frame.find(".edit-loading").append('<div class="progress-bar"><div class="progress-percent"><span>0</span>%</div><div class="progress-track"><div class="progress-track-processed"></div></div></div>'),$.ajax({url:t?n.options.updateUrl:n.options.uploadUrl,type:"POST",data:e,processData:!1,contentType:!1,xhr:function(){var e=$.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",(function(e){if(e.lengthComputable){var t=e.loaded/e.total*100;n.uploadZone.find(".zone-loading .progress-percent span, .edit-loading .progress-percent span").html(t.toFixed(0)),n.uploadZone.find(".zone-loading .progress-track-processed, .edit-loading .progress-track-processed").width(t+"%")}}),!1),e},success:function(e){t?n.items.forEach((function(t,i){n.items[i].id==e.id&&(n.items[i]=e)})):n.items=[e,...n.items],n.itemSelected=[],n.fileUrl=null,n.generateItem(),n.uploadZone.hide(),n.gridLibrary.show(),n.tabLibrary.addClass("active"),n.tabUpload.removeClass("active"),n.uploading=!1,n.frame.find(".footer button.btn-upload").remove(),n.frame.find(".footer button").show(),n.uploadZone.find(".zone-content").html("").hide(),n.uploadZone.find(".zone-info").show(),n.uploadZone.find(".url-file").show(),n.frame.find(".edit-form").remove(),n.frame.find(".edit-form .footer button").removeClass("disable"),n.frame.find(".edit-form .edit-content .edit-loading").remove()},error:function(e){n.uploading=!1,n.frame.find(".footer button.btn-upload").remove(),n.frame.find(".footer button").show(),n.uploadZone.find(".zone-content").html("").hide(),n.uploadZone.find(".zone-info").show(),n.uploadZone.find(".url-file").show(),n.frame.find(".edit-form .footer button").removeClass("disable"),n.frame.find(".edit-form .edit-content .edit-loading").remove(),n.alertPopUp("danger","There is a problem in sending information. Please check your internet connection and try again.")}})}editElement(e){const t=this,n=$(`<div class="edit-form">\n            <div class="header">\n                <div class="title">${this.translate.editFormTitle} ${e.id}</div>\n                <div class="actions">\n                    <button type="button" class="close"><i class="icon-close"></i></button>\n                </div>\n            </div>\n            <div class="edit-content">\n                <div class="edit-preview"></div>\n                <div class="edit-inner-form"></div>\n            </div>\n            <div class="footer">\n                <button type="button" class="btn cancel">${this.translate.editFormCancelButton}</button>\n                <button type="button" class="btn btn-primary save">${this.translate.editFormSaveButton}</button>\n            </div>\n        </div>`);let i=!1,o=!1;t.frame.find(".inner-wrapper").append(n),"external"===t.options.type?n.find(".edit-preview").append(`<a href="${e.url}" target="_blank"><i class="icon-link"></i>${e.url}</a>`):"photo"===t.options.type?(n.find(".edit-preview").append(`<img src="${e.url}" />`),n.find(".edit-preview").append(`<button type="button" class="btn btn-primary btn-full crop">${this.translate.editFormCropButton}</button>`)):"audio"===t.options.type?n.find(".edit-preview").append(`<audio controls><source src="${e.url}" type="audio/mpeg"></audio>`):"video"===t.options.type?n.find(".edit-preview").append(`<video autoplay loop controls><source src="${e.url}" type="video/mp4"></video>`):n.find(".edit-preview").append(`<div class="other-file"><i class="icon-document"></i><div class="file-name">${e.name}</div></div>`),t.options.useTitle&&n.find(".edit-inner-form").append(t.zoneFieldTitle(e.title)),t.options.useDescription&&n.find(".edit-inner-form").append(t.zoneFieldDescription(e.description)),t.options.useTag&&n.find(".edit-inner-form").append(t.zoneFieldTags(e.tags)),n.on("click",".footer button.cancel, .header button.close",(function(){n.remove()})),n.on("click",".edit-preview button.crop",(function(){new PhotoSelector({type:"url",url:o||e.url,aspectRatio:t.options.cropRatio,onDoneCrop:function(e){o=URL.createObjectURL(e.blob),i=e.blob,n.find(".edit-preview img").attr("src",o)}}).crop()})),n.on("click",".footer button.save",(function(){if(t.options.titleRequired&&""===$("[name=title]").val().trim())return $("[name=title]").parents("label").addClass("error"),void t.alertPopUp("danger","Title cannot be empty, please fill it");let o=new FormData;o.append("file",i),o.append("id",e.id),o.append("data",t.options.data),n.find("input").each((function(){const e=$(this),t=e.attr("name");void 0!==t&&o.append(t,e.val())})),t.zoneAjax(o,!0)}))}zonePreview(e,t=null){const n=this,i=$(`<button type="button" class="btn btn-primary btn-upload">${this.translate.uploadZoneUploadButton}</button>`),o=$(`<button type="button" class="btn btn-upload">${this.translate.uploadZoneCancelButton}</button>`),a=$('<div class="zone-form">\n            <div class="zone-preview"></div>\n            <div class="zone-inner-form"></div>\n        </div>');n.uploading=!0,n.frame.find(".footer button").hide(),n.uploadZone.find(".zone-info").hide(),n.uploadZone.find(".url-file").hide(),n.uploadZone.find(".zone-content").show(),n.frame.find(".footer").append([o,i]),null===e?a.find(".zone-preview").append(`<a href="${n.fileUrl}" target="_blank"><i class="icon-link"></i>${n.fileUrl}</a>`):"photo"===n.options.type?a.find(".zone-preview").append(`<img src="${URL.createObjectURL(e)}" />`):"audio"===n.options.type?a.find(".zone-preview").append(`<audio controls><source src="${URL.createObjectURL(e[0])}" type="audio/mpeg"></audio>`):"video"===n.options.type?a.find(".zone-preview").append(`<video autoplay loop controls><source src="${URL.createObjectURL(e[0])}" type="video/mp4"></audio>`):a.find(".zone-preview").append(`<div class="other-file"><i class="icon-document"></i><div class="file-name">${e[0].name}</div></div>`),n.options.useTitle&&a.find(".zone-inner-form").append(n.zoneFieldTitle()),n.options.useDescription&&a.find(".zone-inner-form").append(n.zoneFieldDescription()),n.options.useTag&&a.find(".zone-inner-form").append(n.zoneFieldTags()),o.on("click",(function(){o.remove(),i.remove(),n.frame.find(".footer button").show(),n.uploadZone.find(".zone-info").show(),n.uploadZone.find(".url-file").show(),n.uploadZone.find(".zone-content").html("").hide(),n.uploading=!1})),i.on("click",(function(){if(n.options.titleRequired&&""===$("[name=title]").val().trim())return $("[name=title]").parents("label").addClass("error"),void n.alertPopUp("danger","Title cannot be empty, please fill it");let i=new FormData;i.append("file",e),i.append("filename",t),i.append("fileUrl",n.fileUrl),i.append("data",n.options.data),a.find("input").each((function(){const e=$(this),t=e.attr("name");void 0!==t&&i.append(t,e.val())})),n.zoneAjax(i)})),n.uploadZone.find(".zone-content").html("").append(a)}zoneFieldTitle(e=""){const t=$(`<label><span>${this.translate.uploadZoneFieldTitle}:</span><input type="text" name="title" placeholder="${this.translate.uploadZoneFieldTitlePlaceholder}" value="${e}"></label>`);return this.options.titleRequired&&t.on("input change","input",(function(){""===$(this).val().trim()?$(this).parents("label").addClass("error"):$(this).parents("label").removeClass("error")})),t}zoneFieldDescription(e=""){return $(`<label><span>${this.translate.uploadZoneFieldDesc}:</span><textarea name="description" placeholder="${this.translate.uploadZoneFieldDescPlaceholder}">${e}</textarea></label>`)}zoneFieldTags(e=[]){const t=this,n=$(`<div class="zone-tags">\n            <div class="label">${this.translate.uploadZoneFieldTags}:</div>\n            <div class="tags"></div>\n            <div class="tags-form">\n                <input type="text" placeholder="${this.translate.uploadZoneFieldTagsPlaceholder}">\n                <button type="button" class="btn btn-primary">${this.translate.uploadZoneFieldTagsAdd}</button>\n            </div>\n        </div>`);let i=0;return n.on("keydown",".tags-form input",(function(e){13===e.keyCode&&n.find(".tags-form button").trigger("click")})),n.on("click",".tags-form button",(function(){const e=$(this),o=n.find(".tags-form input");if(""===o.val().trim())return void t.alertPopUp("danger","The tag value cannot be empty");if(void 0===e.attr("data-for")){let e=!1;if(n.find(".tags input").each((function(){$(this).val().trim().toLowerCase()!==o.val().trim().toLowerCase()||(e=$(this).val())})),!1!==e)return void t.alertPopUp("danger","The tag cannot be duplicated")}if(e.attr("data-for")){const i=n.find(`[name="${e.attr("data-for")}"]`);return i.val(o.val().trim()),i.parents(".item").find("span").html(o.val().trim()),o.val(""),e.removeAttr("data-for"),void e.html(t.translate.uploadZoneFieldTagsAdd)}const a=$(`<div class="item">\n                <span>${o.val().trim()}</span>\n                <i class="icon-trash trash"></i>\n                <i class="icon-edit edit"></i>\n                <input type="hidden" name="tags[${i++}]" value="${o.val().trim()}"/>\n            </div>`);a.on("click",".trash",(function(){$(this).parents(".item").remove(),0===n.find(".tags .item").length&&n.find(".tags").hide()})),a.on("click",".edit",(function(){const n=$(this).parents(".item");o.val(n.find("input").val()),e.attr("data-for",n.find("input").attr("name")),e.html(t.translate.uploadZoneFieldTagsSave)})),o.val("").focus(),n.find(".tags").append(a).css("display","flex")})),e.forEach((function(e){n.find(".tags-form input").val(e),n.find(".tags-form button").trigger("click")})),n}alertPopUp(e,t){$("input, select, textarea, button").blur();let n=$('<button type="button" class="btn btn-full btn-primary">Ok</button>'),i=addAlertPopup({class:"",type:"icon",status:e,title:t,actionElements:[n],actionLayout:"horizontal"});n.on("click",(function(){i.distory()}))}isValidURL(e){try{return new URL(e),!0}catch(e){return!1}}photoItem(e){return $(`<img src="${e.thumbnail}" alt="image">`)}videoItem(e){return $(`<img src="${e.thumbnail}" alt="image">`)}audioItem(e){return $(`<div class="audio-card" data-src="${e.url}">\n            <div class="card-content">\n                <div class="card-title" itemprop="name">${e.title}</div>\n                <div class="card-time">\n                    <meta itemprop="duration" content="T2M10S">\n                    <span class="current-time">00:00</span> / <span>${e.duration}</span>\n                </div>\n            </div>\n            <div class="card-controllers">\n                <button class="btn btn-icon play-btn" aria-label="Play Voice"><i class="icon-play"></i></button>\n                <button class="btn btn-icon pause-btn" aria-label="Pause Voice"><i class="icon-pause"></i></button>\n                <div class="slider-control">\n                    <input type="range" min="0" max="100" value="0">\n                    <div class="slider-track"><div class="slider-track-process"></div><div class="slider-track-buffer"></div></div>\n                </div>\n                <div class="card-volume">\n                    <div class="card-volume-progress">\n                        <input type="range" min="0" max="1" step="0.01" value="1">\n                        <div class="slider-track"><div class="slider-track-process" style="width: 100%;"></div><div class="slider-track-buffer"></div></div>\n                    </div>\n                    <button class="btn btn-icon volume-mute-btn" aria-label="Pause Voice"><i class="icon-silence"></i></button>\n                    <button class="btn btn-icon volume-on-btn" aria-label="Pause Voice"><i class="icon-audio"></i></button>\n                </div>\n            </div>\n            <div class="card-loading"><div class="loader-mini"></div></div>\n        </div>`)}otherItems(e){return $(`<div class="other-file"><i class="icon-document"></i><div class="file-name">${e.title}</div></div>`)}}